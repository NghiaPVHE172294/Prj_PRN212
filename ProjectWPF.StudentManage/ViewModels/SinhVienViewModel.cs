using ProjectWPF.DTO.Models;
using ProjectWPF.Service.Services;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Runtime.CompilerServices;
using System.Threading.Tasks;
using System.Windows.Input;
using System.Linq;
using System;
using ProjectWPF.StudentManage.Services;
using Microsoft.Win32;
using System.Windows;

namespace ProjectWPF.StudentManage.ViewModels
{
    public class SinhVienViewModel : INotifyPropertyChanged
    {
        private readonly ISinhVienService _service;
        private readonly IAccountService _accountService;

        public ObservableCollection<SinhVien> SinhViens { get; set; } = new();

        private SinhVien? _selectedSinhVien;
        public SinhVien? SelectedSinhVien
        {
            get => _selectedSinhVien;
            set
            {
                _selectedSinhVien = value;
                // ƒê·∫£m b·∫£o m√£ s·ªë ƒëang ch·ªçn lu√¥n c√≥ trong danh s√°ch ƒë·ªÉ ComboBox hi·ªÉn th·ªã ƒë√∫ng
                if (_selectedSinhVien != null && !string.IsNullOrEmpty(_selectedSinhVien.MaSo) && !DanhSachMaSoAccount.Contains(_selectedSinhVien.MaSo))
                {
                    DanhSachMaSoAccount.Add(_selectedSinhVien.MaSo);
                }
                OnPropertyChanged();
                OnPropertyChanged(nameof(NgaySinhDateTime));
            }
        }

        private string _searchText = string.Empty;
        public string SearchText
        {
            get => _searchText;
            set { _searchText = value; OnPropertyChanged(); }
        }

        private string? _selectedKhoa;
        public string? SelectedKhoa
        {
            get => _selectedKhoa;
            set { _selectedKhoa = value; OnPropertyChanged(); }
        }

        public ObservableCollection<string> DanhSachKhoa { get; set; } = new();
        public ObservableCollection<string> DanhSachMaSoAccount { get; set; } = new();

        private DateTime? _ngaySinhDateTime;
        public DateTime? NgaySinhDateTime
        {
            get => SelectedSinhVien?.NgaySinh != null ? SelectedSinhVien.NgaySinh.Value.ToDateTime(TimeOnly.MinValue) : (DateTime?)null;
            set
            {
                if (SelectedSinhVien != null)
                {
                    SelectedSinhVien.NgaySinh = value.HasValue ? DateOnly.FromDateTime(value.Value) : null;
                    OnPropertyChanged();
                }
            }
        }

        public ICommand AddCommand { get; }
        public ICommand UpdateCommand { get; }
        public ICommand DeleteCommand { get; }
        public ICommand RefreshCommand { get; }
        public ICommand SearchCommand { get; }
        public ICommand ExportExcelCommand { get; }

        private readonly ExcelExportService _excelExportService = new();

        public SinhVienViewModel(ISinhVienService service, IKhoaService khoaService, IAccountService accountService)
        {
            _service = service;
            _accountService = accountService;

            AddCommand = new RelayCommand(async _ => await AddAsync());
            UpdateCommand = new RelayCommand(async _ => await UpdateAsync());
            DeleteCommand = new RelayCommand(async _ => await DeleteAsync());
            RefreshCommand = new RelayCommand(async _ => await LoadDataAsync());
            SearchCommand = new RelayCommand(async _ => await SearchAsync());
            ExportExcelCommand = new RelayCommand(_ => ExportExcel());

            _ = LoadDataAsync();
            _ = LoadDanhSachKhoaAsync(khoaService);
            _ = LoadDanhSachMaSoAccountAsync();

            SelectedSinhVien = new SinhVien(); // G√°n m·∫∑c ƒë·ªãnh khi kh·ªüi t·∫°o
        }

        public async Task LoadDataAsync()
        {
            var list = await _service.GetAllAsync();
            SinhViens.Clear();
            foreach (var sv in list)
                SinhViens.Add(sv);
            await LoadDanhSachMaSoAccountAsync(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch m√£ s·ªë kh·∫£ d·ª•ng khi load l·∫°i
        }

        private async Task LoadDanhSachKhoaAsync(IKhoaService khoaService)
        {
            var khoas = await khoaService.GetAllAsync();
            DanhSachKhoa.Clear();
            DanhSachKhoa.Add(""); // T√πy ch·ªçn t·∫•t c·∫£
            foreach (var k in khoas)
                DanhSachKhoa.Add(k.MaKhoa);
        }

        private async Task LoadDanhSachMaSoAccountAsync()
        {
            var allAccounts = await _accountService.GetAllAsync();
            var allSinhViens = await _service.GetAllAsync();
            var usedMaSo = allSinhViens.Select(sv => sv.MaSo).ToHashSet();
            DanhSachMaSoAccount.Clear();
            foreach (var acc in allAccounts)
            {
                if (acc.Role == "SV" && !usedMaSo.Contains(acc.MaSo))
                    DanhSachMaSoAccount.Add(acc.MaSo);
            }
        }

        private async Task SearchAsync()
        {
            var all = await _service.GetAllAsync();
            var filtered = all;

            if (!string.IsNullOrWhiteSpace(SearchText))
                filtered = filtered.Where(sv => sv.HoTen != null && sv.HoTen.Contains(SearchText, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrWhiteSpace(SelectedKhoa))
                filtered = filtered.Where(sv => sv.MaKhoa == SelectedKhoa);

            SinhViens.Clear();
            foreach (var sv in filtered)
                SinhViens.Add(sv);
        }

        private async Task AddAsync()
        {
            if (SelectedSinhVien != null)
            {
                // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
                if (string.IsNullOrWhiteSpace(SelectedSinhVien.MaSo))
                {
                    MessageBox.Show("M√£ s·ªë sinh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }
                if (!DanhSachMaSoAccount.Contains(SelectedSinhVien.MaSo))
                {
                    MessageBox.Show("M√£ s·ªë n√†y kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ c√≥ sinh vi√™n!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }
                if (string.IsNullOrWhiteSpace(SelectedSinhVien.HoTen))
                {
                    MessageBox.Show("T√™n sinh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }
                if (string.IsNullOrWhiteSpace(SelectedSinhVien.MaKhoa))
                {
                    MessageBox.Show("M√£ khoa kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                // Ki·ªÉm tra tr√πng m√£ s·ªë sinh vi√™n tr∆∞·ªõc khi g·ªçi Service
                var existed = await _service.GetByIdAsync(SelectedSinhVien.MaSo);
                if (existed != null)
                {
                    MessageBox.Show($"M√£ s·ªë sinh vi√™n '{SelectedSinhVien.MaSo}' ƒë√£ t·ªìn t·∫°i!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }

                try
                {
                    await _service.AddAsync(SelectedSinhVien);

                    // üõ† G·ªåI L·∫†I object m·ªõi t·ª´ DB, ƒë·∫£m b·∫£o ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu
                    var svMoi = await _service.GetByIdAsync(SelectedSinhVien.MaSo);

                    // N·∫øu t√¨m ƒë∆∞·ª£c th√¨ add th·ªß c√¥ng
                    if (svMoi != null)
                    {
                        SinhViens.Add(svMoi);
                    }

                    // Ho·∫∑c g·ªçi l·∫°i to√†n b·ªô danh s√°ch n·∫øu th√≠ch
                    // await LoadDataAsync();

                    MessageBox.Show("Th√™m sinh vi√™n th√†nh c√¥ng!", "Th√¥ng b√°o", MessageBoxButton.OK, MessageBoxImage.Information);

                    SelectedSinhVien = new SinhVien();
                    OnPropertyChanged(nameof(SelectedSinhVien));


                }
                catch (Exception ex)
                {
                    MessageBox.Show($"L·ªói khi th√™m sinh vi√™n: {ex.Message}", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private async Task UpdateAsync()
        {
            if (SelectedSinhVien != null)
            {
                if (string.IsNullOrWhiteSpace(SelectedSinhVien.HoTen))
                {
                    MessageBox.Show("T√™n sinh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "L·ªói", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                await _service.UpdateAsync(SelectedSinhVien);
                await LoadDataAsync();
                MessageBox.Show("C·∫≠p nh·∫≠t sinh vi√™n th√†nh c√¥ng!", "Th√¥ng b√°o", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private async Task DeleteAsync()
        {
            if (SelectedSinhVien != null)
            {
                var result = MessageBox.Show($"B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n {SelectedSinhVien.HoTen}?", "X√°c nh·∫≠n x√≥a", MessageBoxButton.YesNo, MessageBoxImage.Question);
                if (result == MessageBoxResult.Yes)
                {
                    await _service.DeleteAsync(SelectedSinhVien.MaSo);
                    await LoadDataAsync();
                    MessageBox.Show("X√≥a sinh vi√™n th√†nh c√¥ng!", "Th√¥ng b√°o", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
        }

        private void ExportExcel()
        {
            var dialog = new SaveFileDialog { Filter = "Excel Files|*.xlsx", FileName = "DanhSachSinhVien.xlsx" };
            if (dialog.ShowDialog() == true)
            {
                _excelExportService.ExportToExcel(SinhViens, dialog.FileName);
            }
        }

        public event PropertyChangedEventHandler? PropertyChanged;
        protected void OnPropertyChanged([CallerMemberName] string? name = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    }
}
